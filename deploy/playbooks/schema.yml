---
# ClickHouse Schema Setup Playbook
# Run: ansible-playbook playbooks/schema.yml
#
# This is IDEMPOTENT - safe to run multiple times.
# All statements use CREATE TABLE/VIEW IF NOT EXISTS.
#
# Note: ClickHouse Cloud doesn't support multi-statement queries via HTTP,
# so we split the schema and run each statement individually.

- name: Setup ClickHouse schema
  hosts: all
  become: true
  become_user: "{{ deploy_user }}"
  vars_files:
    - ../group_vars/all.yml

  tasks:
    - name: Check if .env exists
      ansible.builtin.stat:
        path: "{{ app_dir }}/.env"
      register: env_file

    - name: Fail if .env missing
      ansible.builtin.fail:
        msg: ".env file not found at {{ app_dir }}/.env - create it first with CLICKHOUSE_URL"
      when: not env_file.stat.exists

    - name: Read CLICKHOUSE_URL from .env
      ansible.builtin.shell:
        cmd: grep '^CLICKHOUSE_URL=' {{ app_dir }}/.env | cut -d'=' -f2-
      register: clickhouse_url_from_env
      changed_when: false
      when: clickhouse_url == ""

    - name: Read CLICKHOUSE_USER from .env
      ansible.builtin.shell:
        cmd: grep '^CLICKHOUSE_USER=' {{ app_dir }}/.env | cut -d'=' -f2-
      register: clickhouse_user_from_env
      changed_when: false
      when: clickhouse_user == ""

    - name: Read CLICKHOUSE_PASSWORD from .env
      ansible.builtin.shell:
        cmd: grep '^CLICKHOUSE_PASSWORD=' {{ app_dir }}/.env | cut -d'=' -f2-
      register: clickhouse_password_from_env
      changed_when: false
      when: clickhouse_password == ""

    - name: Set ClickHouse connection vars
      ansible.builtin.set_fact:
        ch_base_url: "{{ clickhouse_url if clickhouse_url != '' else clickhouse_url_from_env.stdout }}"
        ch_user: "{{ clickhouse_user if clickhouse_user != '' else (clickhouse_user_from_env.stdout | default('default')) }}"
        ch_password: "{{ clickhouse_password if clickhouse_password != '' else clickhouse_password_from_env.stdout }}"

    - name: Build ClickHouse URL with credentials
      ansible.builtin.set_fact:
        ch_url: "{{ ch_base_url }}?user={{ ch_user }}&password={{ ch_password }}"

    - name: Validate ClickHouse URL is set
      ansible.builtin.fail:
        msg: "CLICKHOUSE_URL not found in .env or group_vars"
      when: ch_base_url == ""

    - name: Check if schema.sql exists
      ansible.builtin.stat:
        path: "{{ app_dir }}/docs/schema.sql"
      register: schema_file

    - name: Fail if schema.sql missing
      ansible.builtin.fail:
        msg: "schema.sql not found at {{ app_dir }}/docs/schema.sql"
      when: not schema_file.stat.exists

    - name: Create database
      ansible.builtin.shell:
        cmd: |
          curl -sf '{{ ch_url }}' --data 'CREATE DATABASE IF NOT EXISTS nostr'
      register: create_db_result
      changed_when: true

    - name: Create schema runner script
      ansible.builtin.copy:
        dest: "{{ app_dir }}/run_schema.py"
        mode: "0755"
        content: |
          #!/usr/bin/env python3
          """Split schema.sql and run each statement individually.
          ClickHouse Cloud doesn't support multi-statement queries via HTTP.
          """
          import sys
          import re
          import subprocess

          def main():
              if len(sys.argv) != 3:
                  print("Usage: run_schema.py <clickhouse_url> <schema_file>")
                  sys.exit(1)

              ch_url = sys.argv[1]
              schema_file = sys.argv[2]

              # Add database parameter to URL
              if '?' in ch_url:
                  ch_url = f"{ch_url}&database=nostr"
              else:
                  ch_url = f"{ch_url}?database=nostr"

              print("Applying schema to ClickHouse...")

              # Read the schema file
              with open(schema_file, 'r') as f:
                  content = f.read()

              # Remove comments
              content = re.sub(r'--.*$', '', content, flags=re.MULTILINE)

              # Split by semicolons (keeping track of statement boundaries)
              statements = []
              current = ""
              for line in content.split('\n'):
                  line = line.strip()
                  if not line:
                      continue
                  current += " " + line
                  if line.endswith(';'):
                      stmt = current.strip().rstrip(';').strip()
                      if stmt:
                          statements.append(stmt)
                      current = ""

              # Run each statement
              for stmt in statements:
                  # Skip USE and CREATE DATABASE (handled separately)
                  if stmt.upper().startswith('USE ') or 'CREATE DATABASE' in stmt.upper():
                      continue

                  # Skip ALTER TABLE ADD PROJECTION (not supported in ClickHouse Cloud)
                  if 'ADD PROJECTION' in stmt.upper():
                      print(f"  Skipping projection (not supported in ClickHouse Cloud)")
                      continue

                  # Show preview
                  preview = ' '.join(stmt.split())[:70]
                  print(f"  Running: {preview}...")

                  # Write statement to temp file to avoid escaping issues
                  with open('/tmp/ch_stmt.sql', 'w') as f:
                      f.write(stmt)

                  # Execute via curl
                  result = subprocess.run(
                      ['curl', '-sf', ch_url, '--data-binary', '@/tmp/ch_stmt.sql'],
                      capture_output=True,
                      text=True
                  )

                  if result.returncode != 0 or 'Exception' in result.stdout or 'Error' in result.stdout:
                      error_msg = result.stdout or result.stderr
                      if 'already exists' not in error_msg.lower():
                          print(f"  ERROR: {error_msg}")
                          sys.exit(1)
                      else:
                          print(f"  (already exists, skipping)")

              print("Schema applied successfully!")

          if __name__ == '__main__':
              main()

    - name: Run schema script
      ansible.builtin.shell:
        cmd: "python3 {{ app_dir }}/run_schema.py '{{ ch_url }}' '{{ app_dir }}/docs/schema.sql'"
      register: schema_result
      changed_when: true

    - name: Display schema output
      ansible.builtin.debug:
        var: schema_result.stdout_lines

    - name: Verify tables exist
      ansible.builtin.shell:
        cmd: |
          curl -sf '{{ ch_url }}&database=nostr' --data "SELECT name FROM system.tables WHERE database = 'nostr' FORMAT TabSeparated"
      register: tables_result
      changed_when: false

    - name: Show existing tables
      ansible.builtin.debug:
        msg: "Tables in nostr database: {{ tables_result.stdout_lines }}"

    - name: Cleanup schema script
      ansible.builtin.file:
        path: "{{ app_dir }}/run_schema.py"
        state: absent

    - name: Cleanup temp SQL file
      ansible.builtin.file:
        path: /tmp/ch_stmt.sql
        state: absent
